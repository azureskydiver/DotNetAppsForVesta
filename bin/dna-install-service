#!/bin/bash

if [ $# -ne 4 ]
  then
    echo usage: dna-install-service user domain appname port
    exit 1
fi

user=$1
domain=$2
appname=$3
port=$4

workingDirectory="/home/$user/web/$domain/aspnetcore/$appname"
serviceName=kestrel-$domain-$appname.service

echo "Creating service: $serviceName"
. ./lib/mo
cat << EOF | mo > /etc/systemd/system/$serviceName
[Unit]
Description=Kestrel {{domain}} {{appname}}

[Service]
WorkingDirectory={{workingDirectory}}
ExecStart=/usr/bin/dotnet {{workingDirectory}}/{{appname}}.dll --urls http://localhost:{{port}}
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=kestrel-{{domain}}-{{appname}}
User={{user}}
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

[Install]
WantedBy=multi-user.target
EOF

systemctl enable $serviceName
systemctl start $serviceName
